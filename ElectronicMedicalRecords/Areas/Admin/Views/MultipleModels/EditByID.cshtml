@model ElectronicMedicalRecords.Models.MultiplesModel
@{
    ViewBag.Title = "Edit";
}
<style>
    .name-Medication .choices {
        width: 100%
    }

        .name-Medication .choices[data-type*=select-one]:after {
            margin-top: -6px;
        }

    .name-Medication .choices__input--cloned {
        min-width: 100% !important;
    }

    .name-Medication .choices__inner {
        border: unset;
        padding: 0;
        width: 100%;
    }

    .card-header hr {
        color: #009688;
    }

    .patient-taginpust .bootstrap-tagsinput {
        width: 100%;
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        font-weight: 400;
        line-height: 1.5;
        color: #607080;
        background-color: #fff;
        background-clip: padding-box;
        border: 1px solid #dce7f1;
        -webkit-appearance: none;
        -moz-appearance: none;
        border-radius: 0.25rem;
        transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
        box-shadow: unset
    }

        .patient-taginpust .bootstrap-tagsinput .label-info {
            background-color: #435ebe;
            border-radius: 4px;
            padding: 4px
        }

    .table-bordered tr:first-child {
        background-color: #435ebe;
        color: #fff;
        padding: 5px 0;
        text-align: center
    }

    .table-bordered tr:nth-child(2) td {
        border-width: 1px;
    }

    .table-bordered td {
        border-width: 1px
    }

    .pd-0px {
        padding: 0 1rem;
    }

    .navbar-nav {
        display: none
    }

    body {
        background-color: #f5f5f5;
    }

    .imagePreview {
        width: 100%;
        height: 250px;
        background-position: center center;
        background: url(http://cliquecities.com/assets/no-image-e3699ae23f866f6cbdf8ba2443ee5c4e.jpg);
        background-color: #fff;
        background-size: cover;
        background-repeat: no-repeat;
        display: inline-block;
        box-shadow: 0px -3px 6px 2px rgba(0,0,0,0.2);
    }

    .imgUp {
        position: relative;
        margin-bottom: 15px;
    }

    .del {
        position: absolute;
        top: 0px;
        right: 15px;
        width: 30px;
        height: 30px;
        text-align: center;
        line-height: 30px;
        background-color: rgba(255,255,255,0.6);
        cursor: pointer;
    }

    .imgAdd {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background-color: #4bd7ef;
        color: #fff;
        box-shadow: 0px 0px 2px 1px rgba(0,0,0,0.2);
        text-align: center;
        line-height: 30px;
        margin-top: 0px;
        cursor: pointer;
        font-size: 15px;
        padding: 0;
    }
    .choices[data-type*=select-one].is-open:after {
        margin-top: -10px;
    }
    label.invalidForm {
        color: red;
        font-size: 13px
    }
</style>
<header class="mb-3">
    <a href="#" class="burger-btn d-block d-xl-none">
        <i class="bi bi-justify fs-3"></i>
    </a>
</header>
@using (Html.BeginForm("Edit", "MultipleModels", FormMethod.Post, new { enctype = "multipart/form-data", id = "FormEdit" }))
{
    @Html.AntiForgeryToken()
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <a class="nav-link active" id="home-tab" data-bs-toggle="tab" href="#home"
                           role="tab" aria-controls="home" aria-selected="true">Hồ Sơ</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="home-tab" data-bs-toggle="tab" href="#LamSang"
                           role="tab" aria-controls="home" aria-selected="true">Lâm Sàng</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="profile-tab" data-bs-toggle="tab" href="#profile"
                           role="tab" aria-controls="profile" aria-selected="false">Công Thức Máu</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="profile-tab" data-bs-toggle="tab" href="#SinhHoaMau"
                           role="tab" aria-controls="profile" aria-selected="false">Sinh Hóa Máu</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="profile-tab" data-bs-toggle="tab" href="#DongMau"
                           role="tab" aria-controls="profile" aria-selected="false">Đông Máu</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="profile-tab" data-bs-toggle="tab" href="#NhomMau"
                           role="tab" aria-controls="profile" aria-selected="false">Nhóm Máu</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="profile-tab" data-bs-toggle="tab" href="#urine"
                           role="tab" aria-controls="profile" aria-selected="false">Nước Tiểu</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="profile-tab" data-bs-toggle="tab" href="#immune"
                           role="tab" aria-controls="profile" aria-selected="false">Miễn Dịch</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="profile-tab" data-bs-toggle="tab" href="#amniocente"
                           role="tab" aria-controls="profile" aria-selected="false">Dịch Chọc Dò</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="profile-tab" data-bs-toggle="tab" href="#visinh"
                           role="tab" aria-controls="profile" aria-selected="false">Vi Sinh</a>
                    </li>
                </ul>
                <div class="col-12 d-flex justify-content-start pt-4">
                    <button type="submit"
                            class="btn btn-primary me-1 mb-1">
                        Cập Nhât Hồ Sơ
                    </button>
                    <button type="reset"
                            class="btn btn-light-secondary me-1 mb-1">
                        Reset
                    </button>
                </div>
                <div class="tab-content" id="myTabContent">
                    <div class="tab-pane fade show active" id="home" role="tabpanel"
                         aria-labelledby="home-tab">
                        <p class='my-2'>
                            <section id="multiple-column-form">
                                <div class="row match-height">
                                    <div class="col-12">
                                        <div class="card">
                                            @{
                                                Html.RenderAction("Edit", "Patients", new { id = Model.Patient.ID });
                                                Html.RenderAction("Edit", "InformationExaminations", new { id = Model.InformationExamination.ID });
                                                Html.RenderAction("DetailIERead", "Prescription_Detail");
                                            }
                                        </div>
                                    </div>
                                </div>
                            </section>
                        </p>
                    </div>
                    <div class="tab-pane fade" id="LamSang" role="tabpanel"
                         aria-labelledby="profile-tab">
                        <div class="page-heading">
                            <section class="section">
                                <div class="card">
                                    @{
                                        Html.RenderAction("Edit", "Clinicals", new { id = Model.InformationExamination.ID });
                                    }
                                </div>
                            </section>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="profile" role="tabpanel"
                         aria-labelledby="profile-tab">
                        <div class="page-heading">
                            <section class="section">
                                <div class="card">
                                    @{
                                        Html.RenderAction("Edit", "Detail_CTMau", new { id = Model.InformationExamination.ID });
                                    }
                                </div>
                            </section>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="SinhHoaMau" role="tabpanel"
                         aria-labelledby="profile-tab">
                        <div class="page-heading">
                            <section class="section">
                                <div class="card">
                                    @{
                                        Html.RenderAction("Edit", "Detail_SinhHoaMau", new { id = Model.InformationExamination.ID });
                                    }
                                </div>
                            </section>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="DongMau" role="tabpanel"
                         aria-labelledby="profile-tab">
                        <div class="page-heading">
                            <section class="section">
                                <div class="card">
                                    @{
                                        Html.RenderAction("Edit", "Detail_DongMau", new { id = Model.InformationExamination.ID });
                                    }
                                </div>
                            </section>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="NhomMau" role="tabpanel"
                         aria-labelledby="profile-tab">
                        <div class="page-heading">
                            <section class="section">
                                <div class="card">
                                    @{
                                        Html.RenderAction("Edit", "Detail_NhomMau", new { id = Model.InformationExamination.ID });
                                    }
                                </div>
                            </section>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="urine" role="tabpanel"
                         aria-labelledby="profile-tab">
                        <div class="page-heading">
                            <section class="section">
                                <div class="card">
                                    @{
                                        Html.RenderAction("Edit", "Detail_Urine", new { id = Model.InformationExamination.ID });
                                    }
                                </div>
                            </section>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="immune" role="tabpanel"
                         aria-labelledby="profile-tab">
                        <div class="page-heading">
                            <section class="section">
                                <div class="card">
                                    @{
                                        Html.RenderAction("Edit", "Detail_Immune", new { id = Model.InformationExamination.ID });
                                    }
                                </div>
                            </section>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="amniocente" role="tabpanel"
                         aria-labelledby="profile-tab">
                        <div class="page-heading">
                            <section class="section">
                                <div class="card">
                                    @{
                                        Html.RenderAction("Edit", "Detail_Amniocente", new { id = Model.InformationExamination.ID });
                                    }
                                </div>
                            </section>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="visinh" role="tabpanel"
                         aria-labelledby="profile-tab">
                        <div class="page-heading">
                            <section class="section">
                                <div class="card" style="margin-top:1.5rem">
                                    @{
                                        Html.RenderAction("Edit", "Detail_ViSinh", new { id = Model.InformationExamination.ID });
                                    }
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
@section scripts{
    <script>
        var k = 1;
        var formatCss = document.querySelectorAll('.choices__list--single');
        formatCss.forEach((value, i) => {
            value.classList.add('form-control');
            value.style.paddingLeft = '12px';
        })
        @*var select = document.querySelector('#NameMedication');
        select.addEventListener('change', (e) => {
            var id = parseInt(e.target.value);
            $.ajax({
                type: "POST",
                url: "@Url.Action("FindMedication", "Medications")",
                data: { id: id},
                success: (res) => {
                    document.querySelector('#DVT').innerHTML = res.data.Unit;
                    document.querySelector('#IDMedication').setAttribute("value", res.data.ID);
                }
            })
        })*@

        function insRowMedication() {
            var NameMedication = $('#NameMedication').text();
            var UnitMedication = $('#UnitMedication').val();
            var NoteMedication = $('#NoteMedication').val();
            var IdMedication = $('#IDMedication').val();
            var medication = document.getElementById('TableMedication');
            var row = medication.insertRow(k);
            var cell0 = row.insertCell(0);
            var cell1 = row.insertCell(1);
            var cell2 = row.insertCell(2);
            cell0.innerHTML = "<input type='number' name='Prescription_Details" + '[' + (k - 1) + ']' + ".Medication_ID' value='" + IdMedication + "' hidden /> <input style='width:100%;border:none' type='text' value='" + NameMedication + "' readonly/>";
            cell1.innerHTML = "<input style='width:100%;border:none' type='number' name='Prescription_Details" + '[' + (k - 1) + ']' + ".NumMedication' value='" + UnitMedication + "' readonly/>";
            cell2.innerHTML = "<input style='width:100%;border:none' type='text' name='Prescription_Details" + '[' + (k - 1) + ']' + ".Note' value='" + NoteMedication + "' readonly/>";
            k++;
        }
        loadMedication();
        function loadMedication() {
            var InfoID = document.querySelector('#InformationExamination_ID').getAttribute('value');
            var medication = document.getElementById('TableMedication');
            $.ajax({
                type: "POST",
                data: { id: InfoID },
                url: "@Url.Action("LoadPrescription", "Prescription_Detail")",
                success: (res) => {
                    $.each(res.data, function (index, medicationByID) {
                        var row = medication.insertRow(k);
                        var cell0 = row.insertCell(0);
                        var cell1 = row.insertCell(1);
                        var cell2 = row.insertCell(2);
                        cell0.innerHTML = "<input type='number' name='Prescription_Details" + '[' + (k - 1) + ']' + ".InformationExamination_ID' value='" + medicationByID.InformationExamination_ID + "' hidden/> <input type='number' name='Prescription_Details" + '[' + (k - 1) + ']' + ".Medication_ID' value='" + medicationByID.Medication_ID + "' hidden /> <input style='width:100%;border:none;pointer-events: none;' type='text' value='" + medicationByID.Name + "' readonly/>";
                        cell1.innerHTML = "<input style='width:100%;border:none;pointer-events: none;' type='number' name='Prescription_Details" + '[' + (k - 1) + ']' + ".NumMedication' value='" + medicationByID.NumMedication + "' readonly/>";
                        cell2.innerHTML = "<input style='width:100%;border:none;pointer-events: none;' type='text' name='Prescription_Details" + '[' + (k - 1) + ']' + ".Note' value='" + medicationByID.Note + "' readonly/>";
                        k++;
                    })
                }
            })
        }

        function deleteRow(btn) {
            var index = $("#Medication-" + btn);
            index.parent().parent().remove();
            k--;
        }
        var listTable = $('*.tableLoad');
        listTable.each((index, table) => {
            $('#' + table.id).DataTable({
                "pageLength": 50,
                "language": {
                    "emptyTable": "No data available",
                    "oPaginate": {
                        sNext: '<i class="fa fa-chevron-right"></i>',
                        sPrevious: '<i class="fa fa-chevron-left"></i>',
                    },
                    "info": "Hiển thị _START_/_END_ trên tổng _TOTAL_",
                    "lengthMenu": "Hiển thị _MENU_ danh mục thuốc",
                    "search": "Tìm kiếm:",
                },
            });
        })
        //$(".imgAdd").click(function () {
        //    var nameInput = $(this).closest(".row").find("input[type='file']").attr("name");
        //    $(this).closest(".row").find('.imgAdd').before('<div class="col-sm-4 imgUp"><div class="imagePreview"></div><label class="btn btn-primary">Upload<input type="file" multiple class="uploadFile img" name="' + nameInput + '" value="Upload Photo" style="width:0px;height:0px;overflow:hidden;"></label><i class="fa fa-times del"></i></div>');
        //});
        //$(document).on("click", "i.del", function () {
        //    $(this).parent().remove();
        //});
        //$(function () {
        //    $(document).on("change", ".uploadFile", function () {
        //        var uploadFile = $(this);
        //        var files = !!this.files ? this.files : [];
        //        if (!files.length || !window.FileReader) return; // no file selected, or no FileReader support

        //        if (/^image/.test(files[0].type)) { // only image file
        //            var reader = new FileReader(); // instance of the FileReader
        //            reader.readAsDataURL(files[0]); // read the local file

        //            reader.onloadend = function () { // set image data as background of div
        //                //alert(uploadFile.closest(".upimage").find('.imagePreview').length);
        //                uploadFile.closest(".imgUp").find('.imagePreview').css("background-image", "url(" + this.result + ")");
        //            }
        //        }

        //    });
        //});
        const editors = document.querySelectorAll('.editor');
        editors.forEach(item => {
            ClassicEditor
                .create(item, {
                    toolbar: ['bold', 'italic', 'link', 'undo', 'redo', 'numberedList', 'bulletedList']
                })
                .catch(error => {
                    console.error("Toang" + error);
                });
        })
        /*Validate Form*/
        $('form').each((i, obj) => {
            $.validator.addMethod('checkPhoneNumber', function (value, element) {
                return this.optional(element) || /(84|0[3|5|7|8|9])+([0-9]{8})\b/.test(value);
            }, "Vui lòng nhập đúng định dạng");;
            $(function () {
                $(obj).validate({
                    rules: {
                        "Patient.Name": {
                            required: true,
                            normalizer: function (value) {
                                return $.trim(value);
                            }
                        },
                        "Patient.BirthDate": {
                            required: true,
                        },
                        "Patient.NumHome": {
                            required: true,
                            normalizer: function (value) {
                                return $.trim(value);
                            }
                        },
                        "Patient.Address": {
                            required: true,
                            normalizer: function (value) {
                                return $.trim(value);
                            }
                        },
                        "Patient.Phone": {
                            required: true,
                            checkPhoneNumber: true
                        },
                        "Patient.InsuranceCode": {
                            required: true,
                            normalizer: function (value) {
                                return $.trim(value);
                            }
                        }
                    },
                    messages: {
                        "Patient.Name": {
                            required: "Trường này bắt buộc nhập"
                        },
                        "Patient.BirthDate": {
                            required: "Trường này bắt buộc nhập"
                        },
                        "Patient.NumHome": {
                            required: "Trường này bắt buộc nhập"
                        },
                        "Patient.Address": {
                            required: "Trường này bắt buộc nhập"
                        },
                        "Patient.Phone": {
                            required: "Trường này bắt buộc nhập",
                            matches: "Nhập đúng định dạng"
                        },
                        "Patient.InsuranceCode": {
                            required: "Trường này bắt buộc nhập",
                        }
                    },
                    errorClass: 'invalidForm',
                    validClass: 'validForm',
                });
            });
        })

        if (window.location.href.indexOf("Admin/MultipleModels") > -1) {
            $('a[href="/CP24Team08/Admin/Patients"]').parent().addClass("active");
        }
    </script>
}